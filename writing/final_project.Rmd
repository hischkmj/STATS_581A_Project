---
title: "Workers' Compensation"
author: "Molly Hischke & Kyle Hancock"
date: "3/13/2020"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction (4 pts - Kyle)

- Background
- Identify research question(s)
- State response and predictor variables
- Identify each variable as continuous or categorical (with levels)
- Identify observational/experimental units and number of observations
- Further details of design


# Summary statistics and/or graphics (4 pts - Kyle)

```{r Load & Clean Data, warning=FALSE, message=FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(car)
library(emmeans)
library(knitr)

## Reading in raw data
wc <- read_csv("../data/craftbeer_wc.csv")


## CLEANED DATA FRAME
wc2 <- wc %>% 
  group_by(Policy_Dim_Key, year) %>% 
  summarize(avg_payroll = mean(adj_payroll),
            total_claims = sum(Claim_Count)) %>% 
  mutate(claim_filed = ifelse(total_claims == 0, 0, 1)) %>% 
  ungroup() %>% 
  mutate(Policy_Dim_Key = as.factor(Policy_Dim_Key),
         year = as.factor(year)) %>% 
  rename(brewery = Policy_Dim_Key)
```


```{r Data Frame, warning=FALSE, message=FALSE}

## Adds a table to present in the report. 
data_table <- wc2 %>% 
  rename(Brewery = brewery,
         Year = year,
         'Average Payroll' = avg_payroll,
         'Total Claims' = total_claims,
         'Claim Filed?' = claim_filed)

kable(sample_n(data_table, 15, replace = TRUE), 
      caption = "Sample of the brewery worker's compensation claim data.",
      align = "ccccc")

```

```{r Summary Statistics & Graphics}

```

# Analysis (6 pts - Molly)
## Binary Response with Repeated Measures (Model1)

Model1 analysis was done using R and the geepack (Hojsgaard, Halekoh, & Yan 2006; Yan & Fine, 2004; Yan, 2002). Generalized Estimating Equations (GEE) was used to fit a model with the response being if a brewery filed a claim (1 = yes, 0 = no). Fixed effects include payroll (proxy for brewery size). Breweries were used as clusters and we assumed a exchangeable correlation structure.
```{r Binary Response with Repeated Measures}
library(geepack)
Model1 <- geeglm(claim_filed ~ avg_payroll, id = brewery,
                         family = binomial(link = "logit"), 
                         corstr = "exchangeable", data = wc2)

summary(Model1) %>% 
  coefficients

format(exp(3.21e-06), digits = 16)
emmeans(Model1, pairwise ~ avg_payroll, type = "response")

```


```{r Citation Model1}
citation("geepack")

```

## Count Response with Repeated Measures
Model1 analysis was done using R and the geepack (Hojsgaard, Halekoh, & Yan 2006; Yan & Fine, 2004; Yan, 2002). Generalized Estimating Equations (GEE) was used to fit a model with the response being the number of times a  brewery filed a claim within a year. Fixed effects include payroll (proxy for brewery size). Breweries were used as clusters and we assumed a exchangeable correlation structure.

```{r Count Response with Repeated Measures}
library(geepack)
Model2 <- geeglm(total_claims ~ avg_payroll, id = brewery,
                         family = poisson(link = "log"), 
                         corstr = "exchangeable", data = wc2)
summary(Model2) %>% 
  coefficients ()


```

# Results and Conclusions (4 pts - Molly)

- ANOVA style likelihood ratio tests and/or table of estimated coefficients
- Other results as appropriate (ex: pairwise comparisons for categorical predictor)
- Interpretation and discussion (even if nothing is "significant")
- Respond to your research questions

# R code appendix

Add the code chunk from the HW assignments. 





