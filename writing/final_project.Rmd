---
title: "Workers' Compensation"
author: "Molly Hischke & Kyle Hancock"
date: "3/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction (4 pts - Kyle)

- Background
- Identify research question(s)
- State response and predictor variables
- Identify each variable as continuous or categorical (with levels)
- Identify observational/experimental units and number of observations
- Further details of design


# Summary statistics and/or graphics (4 pts - Kyle)

```{r Load & Clean Data}
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(car)
wc <- read_csv("../data/craftbeer_wc.csv")

## Adding column for number of years a brewery had a policy with insurance comp
policy_years <- wc %>% 
  group_by(Policy_Dim_Key, year) %>% 
  summarize(total_claims = n()) %>% 
  ungroup() %>% 
  group_by(Policy_Dim_Key) %>% 
  summarize(years_with_policy = n()) %>% 
  ungroup()


## CLEANED DATAFRAME - USE THIS ONE FOR SUMMARY GRAPHICS & MODELING ##
wc2 <- wc %>% 
  group_by(Policy_Dim_Key, adj_payroll) %>% 
  summarize(total_claims = sum(Claim_Count)) %>% 
  mutate(claim_filed = ifelse(total_claims == 0, 0, 1)) %>% 
  ungroup() %>% 
  full_join(policy_years) 

```

```{r Summary Statistics & Graphics}

```

# Analysis (6 pts - Molly)
```{r Binomial Regression}
# Model 1 - Binomial Logistic Regression
CountModel1 <- glm(claim_filed ~ adj_payroll + years_with_policy,
                   family = binomial, data = wc2)

summary(CountModel1)
Anova(CountModel1)

ggplot(data = wc2, aes(x = adj_payroll, y = claim_filed)) +
  geom_smooth(method = "glm",
              method.args = list(family = binomial))
```

```{r Poisson Regression}
# Model 2 - Poisson Regression
CountModel2 <- glm(total_claims ~ adj_payroll + years_with_policy + adj_payroll*Policy_Dim_Key, 
                   family = poisson(link = "log"), data = wc2)

summary(CountModel2)
Anova(CountModel2)


ggplot(data = wc2, aes(x = adj_payroll, y = total_claims)) +
  geom_smooth(method = "glm",
              method.args = list(family = poisson))

```

# Results and Conclusions (4 pts - Molly)

- ANOVA style likelihood ratio tests and/or table of estimated coefficients
- Other results as appropriate (ex: pairwise comparisons for categorical predictor)
- Interpretation and discussion (even if nothing is "significant")
- Respond to your research questions

# R code appendix

Add the code chunk from the HW assignments. 

# Other Code - 

```{r Size as Categories}
## Separating into different 'groups' for size of brewery
myfun <- function(x) {
  if(x < 10000)
    size = 1
  else if(x >= 10000 && x < 500000)
    size = 2
  else if(x >= 500000)
    size = 3
}

summary(wc$adj_payroll)

## Binomial Regression w/ payroll categories
wc3 <- wc %>% 
  mutate(size = ifelse(adj_payroll < 100000, 1, 
                       ifelse(adj_payroll < 1000000, 2, 3))) 

ggplot(data = wc3, aes(x = size, y = Claim_Count)) +
  geom_smooth(method = "glm",
              method.args = list(family = binomial))


## Poisson Regression w/ categories
wc4 <- wc3 %>% 
  group_by(size, year) %>% 
  summarize(total_claims = n())

ggplot(data = wc4, aes(x = size, y = total_claims)) +
  geom_smooth(method = "glm",
              method.args = list(family = poisson))


```


```{r Testing out original data}
# Trying out some other models using the original dataset.
Model1 <- glm(Claim_Count ~ adj_payroll, family = binomial, data = wc)
summary(Model1)
Anova(Model1)

Model2 <- glm(Claim_Count ~ adj_payroll + Policy_Dim_Key + 
                adj_payroll*Policy_Dim_Key, family = binomial, data = wc)

# Creating a TempData set to plot Model1
TempData <- data.frame(adj_payroll = seq(from = 0, to = 30000000, by = 20000))
TempData$Mod1Pred <- predict(Model1, newdata = TempData, type = "response")
ggplot(data = TempData, aes(x = adj_payroll, y = Mod1Pred)) +
  geom_line(lwd = 2)

ggplot(data = wc, aes(x = adj_payroll, y = Claim_Count)) +
  geom_smooth(method = "glm",
              method.args = list(family = binomial))
```




